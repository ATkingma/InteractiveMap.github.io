<!DOCTYPE html>
<html>

<head>
    <title>Arena Breakout Interactive Map</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet's CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../src/css/leaflet-style.css" />
    <link rel="stylesheet" href="../src/css/sidebar-enhancements.css" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js" crossorigin=""></script>

    <!-- Grouping markers to cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@latest/dist/MarkerCluster.css" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@latest/dist/MarkerCluster.Default.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet.markercluster@latest/dist/leaflet.markercluster.js" crossorigin=""></script>

    <!-- Nested marker cluster -->
    <script src="https://unpkg.com/leaflet.featuregroup.subgroup@latest/dist/leaflet.featuregroup.subgroup.js" crossorigin=""></script>

    <!-- Interactive sidebar -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@latest/css/leaflet-sidebar.min.css" />
    <script src="https://unpkg.com/leaflet-sidebar-v2@latest/js/leaflet-sidebar.min.js"></script>

    <!-- Leaflet editing tools -->
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" crossorigin="" />
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js" crossorigin=""></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <link rel="stylesheet" href="../src/css/leaflet-style.css" />
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="map-navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="index.html" class="brand-link">
                    <i class="fas fa-map-marked-alt"></i>
                    <span class="brand-text">Arena Breakout Maps</span>
                </a>
            </div>
            
            <div class="nav-center">
                <div class="current-page-info">
                    <i class="fas fa-location-dot"></i>
                    <span class="page-indicator">Interactive Map</span>
                    <!-- Map selector dropdown replaces the map name display -->
                    <select id="map-selector" class="map-dropdown">
                        <option value="">Loading maps...</option>
                    </select>
                </div>
            </div>
            
            <div class="nav-actions">
                <button class="nav-btn" onclick="window.location.href='index.html'" title="Back to Main Page">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <!-- Difficulty selector dropdown replaces the menu button -->
                <select id="difficulty-selector" class="difficulty-dropdown nav-dropdown">
                    <option value="">Loading...</option>
                </select>
                <button class="nav-btn" onclick="resetMapView()" title="Reset Map View">
                    <i class="fas fa-refresh"></i>
                    <span>Reset</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Top Ad Space -->
    <div id="top-ad" class="ad-space top-ad">
        <div class="ad-content">
            <h3>Premium Ad Spot</h3>
            <p>Your advertisement here - Top banner space</p>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content">
        <div id="sidebar" class="leaflet-sidebar">
            <!-- Nav tabs -->
            <div class="leaflet-sidebar-tabs">
                <ul role="tablist">
                    <li><a href="#filters" role="tab" data-tooltip="Marker Filtering"><i class="fas fa-filter"></i></a></li>
                    <li><a href="#floors" role="tab" data-tooltip="Floor Selection"><i class="fas fa-building"></i></a></li>
                    <li><a href="#custom-markers" role="tab" data-tooltip="Custom Markers"><i class="fas fa-map-marker-alt"></i></a></li>
                    <li><a href="#drawing" role="tab" data-tooltip="Drawing Tools"><i class="fas fa-pencil-alt"></i></a></li>
                    <li><a href="#info" role="tab" data-tooltip="About & Info"><i class="fas fa-info-circle"></i></a></li>
                    <li><a href="#coordinates" role="tab" data-tooltip="Coordinates"><i class="fas fa-crosshairs"></i></a></li>
                    <li><a href="#github" role="tab" data-tooltip="GitHub Repository"><i class="fab fa-github"></i></a></li>
                    <li><a href="#discord" role="tab" data-tooltip="Discord Community"><i class="fab fa-discord"></i></a></li>
                    <li><a href="#settings" role="tab" data-tooltip="Settings & Actions"><i class="fas fa-cog"></i></a></li>
                </ul>
            </div>

            <!-- Tab panes -->
            <div class="leaflet-sidebar-content">
                <!-- Marker Filters Panel -->
                <div class="leaflet-sidebar-pane" id="filters">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-filter"></i> Marker Filtering
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="filters-container">
                        <div class="filter-section">
                            <h3>🎯 Marker Types</h3>
                            <div class="filter-checkboxes" id="marker-type-filters">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="select-all-filters" class="control-btn secondary">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button id="clear-all-filters" class="control-btn secondary">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Floor Selection Panel -->
                <div class="leaflet-sidebar-pane" id="floors">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-building"></i> Floor Selection
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="floors-container">
                        <div class="floor-info">
                            <p>Switch between different map floors and levels</p>
                        </div>
                        <div class="floor-selector-container" id="sidebar-floor-selector">
                            <!-- Dynamically populated from JSON data -->
                        </div>
                        <div class="floor-preview">
                            <div id="current-floor-info">
                                <strong>Loading...</strong>
                                <p>Floor information will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Markers Panel -->
                <div class="leaflet-sidebar-pane" id="custom-markers">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-map-marker-alt"></i> Custom Markers
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="custom-markers-container">
                        <div class="marker-creation">
                            <h3>Create New Marker</h3>
                            <div class="marker-form">
                                <div class="form-group">
                                    <label for="marker-name">Name:</label>
                                    <input type="text" id="marker-name" placeholder="Enter marker name">
                                </div>
                                <div class="form-group">
                                    <label for="marker-description">Description:</label>
                                    <textarea id="marker-description" placeholder="Enter marker description" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="marker-color">Color:</label>
                                    <div class="color-picker-container">
                                        <input type="color" id="marker-color" value="#ff6b35">
                                        <div class="color-presets">
                                            <button class="color-preset" data-color="#ff6b35" style="background-color: #ff6b35;"></button>
                                            <button class="color-preset" data-color="#ff0000" style="background-color: #ff0000;"></button>
                                            <button class="color-preset" data-color="#00ff00" style="background-color: #00ff00;"></button>
                                            <button class="color-preset" data-color="#0000ff" style="background-color: #0000ff;"></button>
                                            <button class="color-preset" data-color="#ffff00" style="background-color: #ffff00;"></button>
                                            <button class="color-preset" data-color="#ff00ff" style="background-color: #ff00ff;"></button>
                                            <button class="color-preset" data-color="#00ffff" style="background-color: #00ffff;"></button>
                                            <button class="color-preset" data-color="#ffffff" style="background-color: #ffffff;"></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group position-group">
                                    <h4>Position</h4>
                                    <div class="position-options">
                                        <button id="click-to-place" class="control-btn primary">
                                            <i class="fas fa-mouse-pointer"></i> Click on Map
                                        </button>
                                        <div class="coordinate-inputs">
                                            <div class="coord-input">
                                                <label for="marker-x">X:</label>
                                                <input type="number" id="marker-x" placeholder="X coordinate">
                                            </div>
                                            <div class="coord-input">
                                                <label for="marker-y">Y:</label>
                                                <input type="number" id="marker-y" placeholder="Y coordinate">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button id="create-marker" class="control-btn primary">
                                    <i class="fas fa-plus"></i> Create Marker
                                </button>
                            </div>
                        </div>
                        <div class="custom-markers-list">
                            <h3>Your Markers</h3>
                            <div id="custom-markers-container">
                                <p class="no-markers">No custom markers created yet</p>
                            </div>
                            <div class="marker-list-actions">
                                <button id="delete-selected-markers" class="control-btn danger">
                                    <i class="fas fa-trash"></i> Delete Selected
                                </button>
                                <button id="delete-all-markers" class="control-btn danger">
                                    <i class="fas fa-trash-alt"></i> Delete All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Drawing Tools Panel -->
                <div class="leaflet-sidebar-pane" id="drawing">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-pencil-alt"></i> Drawing Tools
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="drawing-container">
                        <div class="drawing-tools">
                            <h3>Drawing Mode</h3>
                            <div class="tool-buttons">
                                <button id="draw-line" class="tool-btn" data-tool="line">
                                    <i class="fas fa-minus"></i> Line
                                </button>
                                <button id="draw-polygon" class="tool-btn" data-tool="polygon">
                                    <i class="fas fa-draw-polygon"></i> Polygon
                                </button>
                                <button id="draw-circle" class="tool-btn" data-tool="circle">
                                    <i class="fas fa-circle"></i> Circle
                                </button>
                                <button id="draw-rectangle" class="tool-btn" data-tool="rectangle">
                                    <i class="fas fa-square"></i> Rectangle
                                </button>
                            </div>
                        </div>
                        <div class="drawing-options">
                            <h3>Style Options</h3>
                            <div class="style-controls">
                                <div class="form-group">
                                    <label for="draw-color">Color:</label>
                                    <input type="color" id="draw-color" value="#ff6b35">
                                </div>
                                <div class="form-group">
                                    <label for="draw-opacity">Opacity:</label>
                                    <input type="range" id="draw-opacity" min="0" max="1" step="0.1" value="0.7">
                                    <span id="opacity-value">70%</span>
                                </div>
                                <div class="form-group">
                                    <label for="draw-weight">Line Weight:</label>
                                    <input type="range" id="draw-weight" min="1" max="10" value="3">
                                    <span id="weight-value">3px</span>
                                </div>
                            </div>
                        </div>
                        <div class="drawing-actions">
                            <button id="clear-drawings" class="control-btn danger">
                                <i class="fas fa-eraser"></i> Clear All Drawings
                            </button>
                            <button id="toggle-drawing-mode" class="control-btn secondary">
                                <i class="fas fa-eye-slash"></i> Disable Drawing
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="leaflet-sidebar-pane" id="info">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-info-circle"></i> About
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="info-container">
                        <div class="site-info">
                            <h3>Arena Breakout Interactive Map</h3>
                            <p>Welcome to the most comprehensive Arena Breakout interactive map experience. This tool provides real-time map navigation, custom marker placement, and advanced filtering capabilities.</p>
                            
                            <h4>Features:</h4>
                            <ul>
                                <li><strong>Multi-floor Navigation:</strong> Switch between different map levels seamlessly</li>
                                <li><strong>Advanced Filtering:</strong> Filter markers by type (ammo, vaults, jackets, medboxes, spawn points, exits, etc.)</li>
                                <li><strong>Custom Markers:</strong> Create and manage your own markers with custom colors</li>
                                <li><strong>Drawing Tools:</strong> Draw lines, polygons, circles, and rectangles for planning</li>
                                <li><strong>Real-time Coordinates:</strong> Track mouse position and navigate to specific coordinates</li>
                                <li><strong>Grid System:</strong> Toggle grid overlay for precise positioning</li>
                            </ul>

                            <h4>How to Use:</h4>
                            <ol>
                                <li><strong>Navigation:</strong> Use mouse wheel to zoom, click and drag to pan</li>
                                <li><strong>Markers:</strong> Click on any marker to see detailed information</li>
                                <li><strong>Filtering:</strong> Use the filter panel to show/hide specific marker types</li>
                                <li><strong>Custom Markers:</strong> Create your own markers by clicking on the map or entering coordinates</li>
                                <li><strong>Drawing:</strong> Use drawing tools to mark routes, areas, or strategies</li>
                                <li><strong>Floors:</strong> Switch between floors using the floor control or sidebar</li>
                            </ol>

                            <div class="version-info">
                                <p><strong>Version:</strong> 2.0.0</p>
                                <p><strong>Last Updated:</strong> December 2024</p>
                                <p><strong>Map Data:</strong> Community sourced and verified</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coordinates Panel -->
                <div class="leaflet-sidebar-pane" id="coordinates">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-crosshairs"></i> Coordinates & Position
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="coordinates-container">
                        <div class="coordinate-display">
                            <h3>Current Mouse Position</h3>
                            <div class="coord-info">
                                <div class="coord-item">
                                    <label>X:</label>
                                    <span id="current-x">0</span>
                                </div>
                                <div class="coord-item">
                                    <label>Y:</label>
                                    <span id="current-y">0</span>
                                </div>
                                <div class="coord-item">
                                    <label>Grid:</label>
                                    <span id="current-grid">A1</span>
                                </div>
                            </div>
                        </div>
                        <div class="coordinate-tools">
                            <h3>Go to Coordinates</h3>
                            <div class="goto-coords">
                                <input type="number" id="goto-x" placeholder="X coordinate">
                                <input type="number" id="goto-y" placeholder="Y coordinate">
                                <button id="goto-button" class="control-btn primary">
                                    <i class="fas fa-location-arrow"></i> Go to Position
                                </button>
                            </div>
                        </div>
                        <div class="coordinate-info">
                            <h3>Selected Marker</h3>
                            <div id="selected-marker-coords">
                                <p>Click on a marker to see its coordinates</p>
                            </div>
                        </div>
                        <div class="coordinate-export">
                            <h3>Export Tools</h3>
                            <button id="copy-coords" class="control-btn secondary">
                                <i class="fas fa-copy"></i> Copy Current Position
                            </button>
                            <button id="export-json" class="control-btn secondary">
                                <i class="fas fa-download"></i> Export Markers as JSON
                            </button>
                        </div>
                    </div>
                </div>

                <!-- GitHub Panel -->
                <div class="leaflet-sidebar-pane" id="github">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fab fa-github"></i> GitHub Repository
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="github-container">
                        <div class="github-info">
                            <h3>Open Source Project</h3>
                            <p>This Arena Breakout Interactive Map is an open-source project. All map data, JSON files, and source code are available on GitHub.</p>
                            
                            <div class="github-links">
                                <a href="https://github.com/ATkingma/InteractiveMap.github.io" target="_blank" class="control-btn primary">
                                    <i class="fab fa-github"></i> View Repository
                                </a>
                                <a href="https://github.com/ATkingma/InteractiveMap.github.io/tree/main/maps" target="_blank" class="control-btn secondary">
                                    <i class="fas fa-folder"></i> Map Data (JSON)
                                </a>
                                <a href="https://github.com/ATkingma/InteractiveMap.github.io/issues" target="_blank" class="control-btn secondary">
                                    <i class="fas fa-bug"></i> Report Issues
                                </a>
                            </div>

                            <h4>Contributing</h4>
                            <p>We welcome contributions! You can help by:</p>
                            <ul>
                                <li>Updating map data and marker locations</li>
                                <li>Adding new maps and floors</li>
                                <li>Reporting bugs and issues</li>
                                <li>Suggesting new features</li>
                                <li>Improving documentation</li>
                            </ul>

                            <h4>Map Data Structure</h4>
                            <p>All map data is stored in JSON format with the following structure:</p>
                            <div class="code-block">
                                <code>
                                    maps/<br>
                                    ├── arena-breakout.json<br>
                                    ├── armory.json<br>
                                    └── [map-name].json
                                </code>
                            </div>

                            <div class="github-stats">
                                <h4>Repository Stats</h4>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <strong>Language:</strong> JavaScript
                                    </div>
                                    <div class="stat-item">
                                        <strong>License:</strong> MIT
                                    </div>
                                    <div class="stat-item">
                                        <strong>Maps:</strong> 2+
                                    </div>
                                    <div class="stat-item">
                                        <strong>Contributors:</strong> Community
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discord Panel -->
                <div class="leaflet-sidebar-pane" id="discord">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fab fa-discord"></i> Community Discord
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="discord-container">
                        <div class="discord-info">
                            <h3>Join Our Community</h3>
                            <p>Connect with other Arena Breakout players, share strategies, get help with the map, and stay updated with the latest features.</p>
                            
                            <div class="discord-features">
                                <h4>What you'll find:</h4>
                                <ul>
                                    <li><strong>🗺️ Map Discussion:</strong> Share findings and discuss map strategies</li>
                                    <li><strong>🚀 Feature Requests:</strong> Suggest new features for the interactive map</li>
                                    <li><strong>🐛 Bug Reports:</strong> Report issues and get quick support</li>
                                    <li><strong>📡 Updates:</strong> Get notified about new map releases</li>
                                    <li><strong>🎮 General Chat:</strong> Discuss Arena Breakout gameplay</li>
                                    <li><strong>💡 Tips & Tricks:</strong> Share and learn advanced strategies</li>
                                </ul>
                            </div>

                            <div class="discord-invite">
                                <a href="https://discord.gg/your-discord-server" target="_blank" class="control-btn primary discord-btn">
                                    <i class="fab fa-discord"></i> Join Discord Server
                                </a>
                            </div>

                            <div class="community-rules">
                                <h4>Community Guidelines</h4>
                                <ul>
                                    <li>Be respectful to all community members</li>
                                    <li>Stay on topic in appropriate channels</li>
                                    <li>No spam or excessive self-promotion</li>
                                    <li>Help newcomers and share knowledge</li>
                                    <li>Report bugs constructively with details</li>
                                </ul>
                            </div>

                            <div class="discord-stats">
                                <h4>Server Info</h4>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <strong>Members:</strong> 500+
                                    </div>
                                    <div class="stat-item">
                                        <strong>Channels:</strong> 10+
                                    </div>
                                    <div class="stat-item">
                                        <strong>Active:</strong> 24/7
                                    </div>
                                    <div class="stat-item">
                                        <strong>Language:</strong> English
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="leaflet-sidebar-pane" id="settings">
                    <h1 class="leaflet-sidebar-header">
                        <i class="fas fa-cog"></i> Settings & Actions
                        <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                    </h1>
                    <div class="settings-container">
                        <div class="settings-section">
                            <h3>Map Settings</h3>
                            <div class="setting-item">
                                <label for="grid-toggle">Show Grid:</label>
                                <input type="checkbox" id="grid-toggle">
                            </div>
                            <div class="setting-item">
                                <label for="grid-size-setting">Grid Size:</label>
                                <select id="grid-size-setting">
                                    <option value="100">100px</option>
                                    <option value="200" selected>200px</option>
                                    <option value="400">400px</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="marker-scale">Marker Scale:</label>
                                <input type="range" id="marker-scale" min="0.5" max="2" step="0.1" value="1">
                                <span id="scale-value">100%</span>
                            </div>
                        </div>

                        <div class="actions-section">
                            <h3>Data Actions</h3>
                            <div class="action-buttons">
                                <button id="export-all-data" class="control-btn primary">
                                    <i class="fas fa-download"></i> Export All Data
                                </button>
                                <button id="import-data" class="control-btn secondary">
                                    <i class="fas fa-upload"></i> Import Data
                                </button>
                                <input type="file" id="import-file" accept=".json" style="display: none;">
                            </div>
                        </div>

                        <div class="danger-section">
                            <h3>Danger Zone</h3>
                            <div class="danger-actions">
                                <button id="hard-delete" class="control-btn danger">
                                    <i class="fas fa-trash"></i> Hard Delete All Custom Data
                                </button>
                                <button id="hard-reset" class="control-btn danger">
                                    <i class="fas fa-undo"></i> Hard Reset Map
                                </button>
                            </div>
                            <div class="danger-warning">
                                <p><strong>⚠️ Warning:</strong> These actions cannot be undone!</p>
                                <ul>
                                    <li><strong>Hard Delete:</strong> Removes all custom markers and drawings</li>
                                    <li><strong>Hard Reset:</strong> Resets map to initial state (position, zoom, filters)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="about-section">
                            <h3>About</h3>
                            <div class="version-info">
                                <p><strong>Version:</strong> 2.0.0</p>
                                <p><strong>Build:</strong> 2024.12.25</p>
                                <p><strong>Engine:</strong> Leaflet.js</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <!-- Independent Sidebar Close Control -->
        <div id="sidebar-close-control" class="sidebar-close-control">
            <a href="#" class="sidebar-close-btn" onclick="closeSidebar(); return false;" title="Close Sidebar">
                <i class="fas fa-times"></i>
            </a>
        </div>
        
        <!-- Bottom Ad Space -->
        <div id="bottom-ad" class="ad-space bottom-ad">
            <div class="ad-content">
                <h3>Featured Advertisement</h3>
                <p>Your advertisement here - Featured banner space</p>
            </div>
        </div>
        
    </div>

    <!-- include classes -->
    <script src="../src/js/leaflet/custom_layers.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/interactive_layer.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/interactive_map.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/share_marker.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/utils.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/floor_control.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/map_data_manager.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/enhanced_marker_system.js" type="text/javascript"></script>
    <script src="../src/js/leaflet/enhanced_map_features.js" type="text/javascript"></script>

    <!-- include map specific stuff -->
    <script src="../src/js/leaflet/arena_breakout_map.js" type="text/javascript"></script>
    
    <script>
        // Modern Sidebar Functions
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            if (sidebar) {
                if (sidebar.classList.contains('collapsed')) {
                    openSidebar();
                } else {
                    closeSidebar();
                }
            }
        }
        
        function openSidebar() {
            var sidebar = document.getElementById('sidebar');
            var closeControl = document.getElementById('sidebar-close-control');
            if (sidebar) {
                sidebar.classList.remove('collapsed');
                adjustMapControls();
            }
            if (closeControl) {
                closeControl.classList.add('visible');
            }
        }
        
        function closeSidebar() {
            var sidebar = document.getElementById('sidebar');
            var closeControl = document.getElementById('sidebar-close-control');
            if (sidebar) {
                sidebar.classList.add('collapsed');
                adjustMapControls();
            }
            if (closeControl) {
                closeControl.classList.remove('visible');
            }
        }
        
        function adjustMapControls() {
            // Force map to resize and reposition controls
            setTimeout(() => {
                if (window.interactive_map && window.interactive_map.getMap()) {
                    window.interactive_map.getMap().invalidateSize();
                }
            }, 300);
        }
        
        function resetMapView() {
            if (window.interactive_map && window.interactive_map.getMap()) {
                const map = window.interactive_map.getMap();
                // Reset to default bounds
                const mapBounds = [[0, 0], [2158, 4078]];
                map.fitBounds(mapBounds, {
                    padding: [50, 50],
                    maxZoom: -1
                });
                console.log('Map view reset to default');
            }
        }
        
        function updateMapName() {
            const mapNameElement = document.getElementById('current-map-name');
            let selectedMap = sessionStorage.getItem('selectedMap') || 'arena-breakout';
            
            // If we have loaded map data, use the actual map name from the data
            if (window.mapDataManager && window.mapDataManager.mapData) {
                selectedMap = window.mapDataManager.mapData.mapName;
            }
            
            // Format map name for display
            const displayName = selectedMap
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
                
            if (mapNameElement) {
                mapNameElement.textContent = displayName;
            }
            
            // Also update page title
            document.title = `${displayName} - Arena Breakout Interactive Map`;
        }

        // ==================== DROPDOWN FUNCTIONALITY ====================
        
        // Protect against dropdown clearing by overriding innerHTML setter
        function protectDropdownFromClearing() {
            console.log('🛡️ Setting up dropdown innerHTML protection...');
            
            const difficultySelector = document.getElementById('difficulty-selector');
            if (!difficultySelector) return;
            
            // Store the original innerHTML setter
            const originalInnerHTMLSetter = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
            
            // Override the innerHTML setter specifically for this element
            Object.defineProperty(difficultySelector, 'innerHTML', {
                set: function(value) {
                    // If someone tries to clear the dropdown, log it and potentially prevent it
                    if (value === '' || value === '<option value="">Loading...</option>') {
                        console.warn('🚨 Attempt to clear difficulty dropdown detected!');
                        console.trace('Stack trace of clearing attempt');
                        
                        // If we have protected options, restore them instead
                        if (window.protectedDifficultyOptions && window.protectedDifficultyOptions.length > 0) {
                            console.log('🔄 Preventing clear and restoring options instead');
                            
                            // Use the original setter to clear first
                            originalInnerHTMLSetter.call(this, '');
                            
                            // Then add our protected options back
                            window.protectedDifficultyOptions.forEach(optionData => {
                                const option = document.createElement('option');
                                option.value = optionData.value;
                                option.textContent = optionData.text;
                                this.appendChild(option);
                            });
                            
                            // Restore saved value
                            const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                            if (savedDifficulty && this.querySelector(`option[value="${savedDifficulty}"]`)) {
                                this.value = savedDifficulty;
                            }
                            
                            return; // Don't execute the clearing
                        }
                    }
                    
                    // For any other content, use the original setter
                    originalInnerHTMLSetter.call(this, value);
                },
                get: function() {
                    return this.innerHTML;
                },
                configurable: true
            });
            
            console.log('✅ Dropdown innerHTML protection activated');
        }
        
        // Utility functions for formatting
        function formatMapName(mapName) {
            return mapName
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        function formatDifficultyName(difficulty) {
            return difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification - positioned at top right
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#ff8c00' : '#ff8c00'};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 20000;
                font-weight: bold;
                max-width: 300px;
                word-wrap: break-word;
                border: 2px solid ${type === 'error' ? '#ff6666' : type === 'success' ? '#ffb3475' : '#ffb347'};
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Load available maps from the maps folder
        async function loadAvailableMaps() {
            console.log('Loading available maps...');
            
            try {
                // List of known maps (you can expand this dynamically if needed)
                const availableMaps = ['arena-breakout', 'armory'];
                
                const mapSelector = document.getElementById('map-selector');
                if (!mapSelector) {
                    console.error('Map selector not found');
                    return;
                }
                
                // Clear existing options
                mapSelector.innerHTML = '';
                
                // Add maps as options
                for (const mapName of availableMaps) {
                    try {
                        // Test if the map file exists
                        const response = await fetch(`../maps/${mapName}.json`);
                        if (response.ok) {
                            const option = document.createElement('option');
                            option.value = mapName;
                            option.textContent = formatMapName(mapName);
                            mapSelector.appendChild(option);
                            console.log('Added map option:', mapName);
                        }
                    } catch (error) {
                        console.warn(`Map ${mapName} not available:`, error);
                    }
                }
                
                // Set current selection
                const currentMap = sessionStorage.getItem('selectedMap') || 'arena-breakout';
                if (mapSelector.querySelector(`option[value="${currentMap}"]`)) {
                    mapSelector.value = currentMap;
                } else if (mapSelector.options.length > 0) {
                    mapSelector.value = mapSelector.options[0].value;
                    sessionStorage.setItem('selectedMap', mapSelector.options[0].value);
                }
                
                console.log('Available maps loaded successfully');
                
            } catch (error) {
                console.error('Error loading available maps:', error);
                
                // Fallback
                const mapSelector = document.getElementById('map-selector');
                if (mapSelector) {
                    mapSelector.innerHTML = '<option value="arena-breakout">Arena Breakout</option>';
                    mapSelector.value = 'arena-breakout';
                }
            }
        }
        
        // Load difficulties for a specific map
        async function loadDifficultiesForMap(mapName) {
            console.log('Loading difficulties for map:', mapName);
            
            try {
                const response = await fetch(`../maps/${mapName}.json`);
                if (!response.ok) {
                    throw new Error(`Map not found: ${response.status}`);
                }
                
                const mapData = await response.json();
                console.log('Map data loaded:', mapData);
                
                const difficultySelector = document.getElementById('difficulty-selector');
                
                if (!difficultySelector) {
                    console.error('Difficulty selector not found');
                    return {};
                }
                
                // Store current value before clearing
                const currentValue = difficultySelector.value;
                
                // Clear existing options
                difficultySelector.innerHTML = '';
                
                if (mapData.difficulties) {
                    const difficultyKeys = Object.keys(mapData.difficulties);
                    console.log('Found difficulties:', difficultyKeys);
                    
                    if (difficultyKeys.length === 0) {
                        console.warn('No difficulties found in map data');
                        throw new Error('No difficulties found');
                    }
                    
                    // Get the difficulty keys directly from the JSON
                    difficultyKeys.forEach(difficultyKey => {
                        const option = document.createElement('option');
                        option.value = difficultyKey;
                        option.textContent = formatDifficultyName(difficultyKey);
                        difficultySelector.appendChild(option);
                        console.log('Added difficulty option:', difficultyKey);
                    });
                    
                    // Set saved difficulty or default
                    const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                    let targetDifficulty = null;
                    
                    // Priority: saved difficulty > current value > first available
                    if (savedDifficulty && difficultySelector.querySelector(`option[value="${savedDifficulty}"]`)) {
                        targetDifficulty = savedDifficulty;
                        console.log('Using saved difficulty:', savedDifficulty);
                    } else if (currentValue && difficultySelector.querySelector(`option[value="${currentValue}"]`)) {
                        targetDifficulty = currentValue;
                        console.log('Using previous difficulty:', currentValue);
                    } else {
                        targetDifficulty = difficultyKeys[0];
                        console.log('Using first available difficulty:', targetDifficulty);
                    }
                    
                    if (targetDifficulty) {
                        difficultySelector.value = targetDifficulty;
                        sessionStorage.setItem('selectedDifficulty', targetDifficulty);
                    }
                    
                    // Store the options globally for protection
                    window.protectedDifficultyOptions = difficultyKeys.map(key => ({
                        value: key,
                        text: formatDifficultyName(key)
                    }));
                    
                    // Setup protection after a delay
                    setTimeout(() => {
                        protectDifficultyDropdown();
                    }, 500);
                    
                } else {
                    console.log('No difficulties found in map data, using defaults');
                    // Fallback to default difficulties if none specified in JSON
                    const defaultDifficulties = ['normal', 'hard', 'nightmare'];
                    defaultDifficulties.forEach(diff => {
                        const option = document.createElement('option');
                        option.value = diff;
                        option.textContent = formatDifficultyName(diff);
                        difficultySelector.appendChild(option);
                        console.log('Added default difficulty option:', diff);
                    });
                    
                    difficultySelector.value = 'normal';
                    sessionStorage.setItem('selectedDifficulty', 'normal');
                    
                    // Store the options globally for protection
                    window.protectedDifficultyOptions = defaultDifficulties.map(diff => ({
                        value: diff,
                        text: formatDifficultyName(diff)
                    }));
                    
                    // Setup protection
                    setTimeout(() => {
                        protectDifficultyDropdown();
                    }, 500);
                }
                
                console.log('Difficulty selector populated with', difficultySelector.options.length, 'options');
                console.log('Selected difficulty:', difficultySelector.value);
                
                return mapData.difficulties || {};
                
            } catch (error) {
                console.error('Error loading difficulties for map:', error);
                
                // Fallback difficulties
                const difficultySelector = document.getElementById('difficulty-selector');
                if (difficultySelector) {
                    difficultySelector.innerHTML = '';
                    
                    const defaultDifficulties = ['normal', 'hard', 'nightmare'];
                    defaultDifficulties.forEach(diff => {
                        const option = document.createElement('option');
                        option.value = diff;
                        option.textContent = formatDifficultyName(diff);
                        difficultySelector.appendChild(option);
                        console.log('Added fallback difficulty option:', diff);
                    });
                    
                    difficultySelector.value = 'normal';
                    sessionStorage.setItem('selectedDifficulty', 'normal');
                    
                    // Store the options globally for protection
                    window.protectedDifficultyOptions = defaultDifficulties.map(diff => ({
                        value: diff,
                        text: formatDifficultyName(diff)
                    }));
                    
                    // Setup protection
                    setTimeout(() => {
                        protectDifficultyDropdown();
                    }, 500);
                }
                
                return {};
            }
        }
        
        // Protection function to prevent other scripts from clearing the dropdown
        function protectDifficultyDropdown() {
            const difficultySelector = document.getElementById('difficulty-selector');
            if (!difficultySelector || !window.protectedDifficultyOptions) {
                console.log('Protection not set up - missing selector or options');
                return;
            }
            
            console.log('Setting up dropdown protection for', window.protectedDifficultyOptions.length, 'options');
            
            // Create a MutationObserver to watch for changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        // Check if the dropdown was cleared or has only loading text
                        if (difficultySelector.options.length === 0 || 
                            (difficultySelector.options.length === 1 && 
                             (difficultySelector.options[0].textContent === 'Loading...' || 
                              difficultySelector.options[0].value === ''))) {
                            
                            console.warn('🚨 Difficulty dropdown was cleared! Restoring options...');
                            console.trace('Stack trace of clearing operation');
                            
                            // Restore the options immediately
                            difficultySelector.innerHTML = '';
                            window.protectedDifficultyOptions.forEach(optionData => {
                                const option = document.createElement('option');
                                option.value = optionData.value;
                                option.textContent = optionData.text;
                                difficultySelector.appendChild(option);
                            });
                            
                            // Restore the selected value
                            const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                            if (savedDifficulty && difficultySelector.querySelector(`option[value="${savedDifficulty}"]`)) {
                                difficultySelector.value = savedDifficulty;
                                console.log('✅ Restored dropdown with', difficultySelector.options.length, 'options and selected:', savedDifficulty);
                            } else if (difficultySelector.options.length > 0) {
                                difficultySelector.value = difficultySelector.options[0].value;
                                console.log('✅ Restored dropdown with', difficultySelector.options.length, 'options and selected first option');
                            }
                        }
                    }
                });
            });
            
            // Start observing
            observer.observe(difficultySelector, {
                childList: true,
                subtree: true
            });
            
            // Also set up a periodic check as backup
            const intervalId = setInterval(() => {
                if (difficultySelector.options.length === 0 || 
                    (difficultySelector.options.length === 1 && 
                     (difficultySelector.options[0].textContent === 'Loading...' || 
                      difficultySelector.options[0].value === ''))) {
                    
                    console.warn('⏰ Periodic check: Difficulty dropdown is empty! Restoring...');
                    
                    if (window.protectedDifficultyOptions) {
                        difficultySelector.innerHTML = '';
                        window.protectedDifficultyOptions.forEach(optionData => {
                            const option = document.createElement('option');
                            option.value = optionData.value;
                            option.textContent = optionData.text;
                            difficultySelector.appendChild(option);
                        });
                        
                        const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                        if (savedDifficulty && difficultySelector.querySelector(`option[value="${savedDifficulty}"]`)) {
                            difficultySelector.value = savedDifficulty;
                        } else if (difficultySelector.options.length > 0) {
                            difficultySelector.value = difficultySelector.options[0].value;
                        }
                        
                        console.log('✅ Periodic restore completed with', difficultySelector.options.length, 'options');
                    }
                }
            }, 1000); // Check every second
            
            // Store the interval ID so we can clear it later if needed
            window.protectionIntervalId = intervalId;
            
            console.log('✅ Dropdown protection system activated');
        }
        
        // Initialize map and difficulty selectors
        async function initializeMapAndDifficultySelectors() {
            console.log('Initializing map and difficulty selectors...');
            
            try {
                // Load available maps
                await loadAvailableMaps();
                
                // Get current map from session storage or default
                const currentMap = sessionStorage.getItem('selectedMap') || 'arena-breakout';
                const mapSelector = document.getElementById('map-selector');
                
                console.log('Current map:', currentMap);
                console.log('Available options:', Array.from(mapSelector.options).map(opt => opt.value));
                
                // Set current map selection
                if (mapSelector.querySelector(`option[value="${currentMap}"]`)) {
                    mapSelector.value = currentMap;
                    console.log('Set map selector to:', currentMap);
                } else {
                    // If saved map doesn't exist, use the first available map
                    const firstOption = mapSelector.options[0];
                    if (firstOption && firstOption.value) {
                        mapSelector.value = firstOption.value;
                        sessionStorage.setItem('selectedMap', firstOption.value);
                        console.log('Set map selector to first available:', firstOption.value);
                    }
                }
                
                // Load difficulties for the current map
                const selectedMap = mapSelector.value || 'arena-breakout';
                console.log('Loading difficulties for map:', selectedMap);
                await loadDifficultiesForMap(selectedMap);
                
                // Set up saved difficulty
                const difficultySelector = document.getElementById('difficulty-selector');
                const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                
                if (savedDifficulty && difficultySelector.querySelector(`option[value="${savedDifficulty}"]`)) {
                    difficultySelector.value = savedDifficulty;
                    console.log('Set difficulty selector to saved:', savedDifficulty);
                } else if (difficultySelector.options.length > 0) {
                    difficultySelector.value = difficultySelector.options[0].value;
                    sessionStorage.setItem('selectedDifficulty', difficultySelector.options[0].value);
                    console.log('Set difficulty selector to first available:', difficultySelector.options[0].value);
                }
                
            } catch (error) {
                console.error('Error initializing selectors:', error);
            }
            
            // Set up event listeners for dropdowns
            const mapSelector = document.getElementById('map-selector');
            const difficultySelector = document.getElementById('difficulty-selector');
            
            if (mapSelector) {
                mapSelector.addEventListener('change', async function() {
                    const selectedMap = this.value;
                    console.log('Map changed to:', selectedMap);
                    sessionStorage.setItem('selectedMap', selectedMap);
                    
                    // Load difficulties for the new map
                    try {
                        await loadDifficultiesForMap(selectedMap);
                        showNotification(`Switched to ${formatMapName(selectedMap)}`);
                        
                        // Reload the page to load new map
                        window.location.reload();
                    } catch (error) {
                        console.error('Error switching map:', error);
                        showNotification(`Error switching to ${formatMapName(selectedMap)}`, 'error');
                    }
                });
            }
            
            if (difficultySelector) {
                difficultySelector.addEventListener('change', async function() {
                    const selectedDifficulty = this.value;
                    console.log('=== DIFFICULTY CHANGE EVENT ===');
                    console.log('Difficulty changed to:', selectedDifficulty);
                    sessionStorage.setItem('selectedDifficulty', selectedDifficulty);
                    
                    showNotification(`Switching to ${formatDifficultyName(selectedDifficulty)}...`);
                    
                    // Add a longer delay to ensure all systems are ready and force a complete reload
                    setTimeout(async () => {
                        try {
                            console.log('Starting difficulty change process...');
                            
                            // Force complete marker reload (without applyDifficultySettings to avoid interference)
                            await reloadMarkersForDifficulty(selectedDifficulty);
                            
                            // Additional safety check - force another update
                            setTimeout(() => {
                                if (window.markerSystem && typeof window.markerSystem.updateMarkers === 'function') {
                                    console.log('Safety update - forcing final marker refresh...');
                                    window11.markerSystem.updateMarkers();
                                }
                            }, 500);
                            
                            showNotification(`Difficulty set to ${formatDifficultyName(selectedDifficulty)}`, 'success');
                            console.log('=== DIFFICULTY CHANGE COMPLETED ===');
                            
                        } catch (error) {
                            console.error('=== ERROR IN DIFFICULTY CHANGE ===', error);
                            showNotification(`Error loading ${formatDifficultyName(selectedDifficulty)} markers`, 'error');
                        }
                    }, 100); // Reduced delay for faster response
                });
            }
            
            // Log final state
            console.log('Final state - Map options:', mapSelector?.options.length || 0);
            console.log('Final state - Difficulty options:', difficultySelector?.options.length || 0);
        }
        
        // Helper function to check if marker system is ready
        function isMarkerSystemReady() {
            return window.markerSystem && 
                   window.mapDataManager && 
                   window.mapDataManager.mapData &&
                   typeof window.markerSystem.updateMarkers === 'function' &&
                   typeof window.markerSystem.clearMarkers === 'function';
        }
        
        // Helper function to wait for marker system to be ready
        function waitForMarkerSystem(maxWait = 5000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkReady = () => {
                    if (isMarkerSystemReady()) {
                        console.log('Marker system is ready!');
                        resolve();
                    } else if (Date.now() - startTime > maxWait) {
                        reject(new Error('Marker system not ready after maximum wait time'));
                    } else {
                        setTimeout(checkReady, 100);
                    }
                };
                
                checkReady();
            });
        }
        
        // Reload markers for difficulty
        // Reload markers for difficulty - simplified and safe approach
        async function reloadMarkersForDifficulty(difficulty) {
            try {
                console.log('=== Reloading markers for difficulty:', difficulty, '===');
                
                // Wait for marker system to be ready
                await waitForMarkerSystem();
                
                // Store the current difficulty selection
                sessionStorage.setItem('selectedDifficulty', difficulty);
                console.log('Stored difficulty in sessionStorage:', difficulty);
                
                // Use the marker system's built-in setDifficulty method
                if (window.markerSystem && typeof window.markerSystem.setDifficulty === 'function') {
                    console.log('Using marker system setDifficulty method...');
                    window.markerSystem.setDifficulty(difficulty);
                    console.log('✅ Marker system updated for difficulty:', difficulty);
                } else {
                    console.log('setDifficulty not available, using manual approach...');
                    
                    // Fallback: Update map data manager
                    if (window.mapDataManager) {
                        if (typeof window.mapDataManager.setDifficulty === 'function') {
                            window.mapDataManager.setDifficulty(difficulty);
                        } else {
                            window.mapDataManager.currentDifficulty = difficulty;
                            if (window.mapDataManager.mapData && typeof window.mapDataManager.mapData.getAllTypes === 'function') {
                                window.mapDataManager.enabledTypes = new Set(window.mapDataManager.mapData.getAllTypes(difficulty));
                            }
                        }
                        console.log('✅ Map data manager updated for difficulty:', difficulty);
                    }
                    
                    // Update floor control
                    if (window.floorControl && typeof window.floorControl.setDifficulty === 'function') {
                        window.floorControl.setDifficulty(difficulty);
                        console.log('✅ Floor control updated for difficulty:', difficulty);
                    }
                    
                    // Update markers
                    if (window.markerSystem && typeof window.markerSystem.updateMarkers === 'function') {
                        window.markerSystem.updateMarkers();
                        console.log('✅ Markers updated for difficulty:', difficulty);
                    }
                }
                
                // Force map refresh
                setTimeout(() => {
                    if (window.interactive_map && window.interactive_map.getMap()) {
                        window.interactive_map.getMap().invalidateSize();
                    }
                }, 100);
                
                console.log('=== ✅ Markers successfully reloaded for difficulty:', difficulty, '===');
                
            } catch (error) {
                console.error('=== ❌ Error reloading markers for difficulty:', error, '===');
                showNotification(`Error loading ${difficulty} markers: ${error.message}`, 'error');
            }
        }
        
        function switchMap(mapName) {
            if (mapName && mapName !== sessionStorage.getItem('selectedMap')) {
                sessionStorage.setItem('selectedMap', mapName);
                // Reload the page to load the new map
                window.location.reload();
            }
        }
        
        function switchDifficulty(difficulty) {
            if (difficulty) {
                sessionStorage.setItem('selectedDifficulty', difficulty);
                console.log('Difficulty switched to:', difficulty);
                
                // Apply difficulty-specific settings
                applyDifficultySettings(difficulty);
                
                // Reload markers for the new difficulty
                reloadMarkersForDifficulty(difficulty);
                
                // Show notification
                showNotification(`Difficulty changed to: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`);
            }
        }
        
        function applyDifficultySettings(difficulty) {
            // Apply different marker visibility or map features based on difficulty
            if (window.interactive_map && window.interactive_map.getMap()) {
                const map = window.interactive_map.getMap();
                
                // Log the difficulty being applied
                console.log(`Applying ${difficulty} difficulty settings...`);
                
                // Update any difficulty-specific UI elements or features
                switch(difficulty) {
                    case 'normal':
                        // Normal mode - all features available
                        console.log('Normal mode: All markers and features visible');
                        break;
                    case 'hard':
                        // Hard mode - reduced assistance
                        console.log('Hard mode: Reduced marker assistance');
                        break;
                    case 'nightmare':
                        // Nightmare mode - minimal assistance
                        console.log('Nightmare mode: Minimal marker assistance');
                        break;
                    case 'lockdown':
                        // Lockdown mode - special restrictions
                        console.log('Lockdown mode: Special restrictions applied');
                        break;
                    case 'forbidden':
                        // Forbidden zone - maximum difficulty
                        console.log('Forbidden mode: Maximum difficulty settings');
                        break;
                    default:
                        // Default settings
                        console.log('Default difficulty settings applied');
                        break;
                }
                
                // Future: Add difficulty-specific features here
                // For now, we'll just ensure the markers are properly loaded for the difficulty
                if (window.markerSystem && typeof window.markerSystem.updateMarkers === 'function') {
                    // Ensure markers are updated for the current difficulty
                    setTimeout(() => {
                        window.markerSystem.updateMarkers();
                        console.log(`Markers updated for ${difficulty} difficulty`);
                    }, 100);
                }
                
                console.log(`✅ ${difficulty} difficulty settings applied successfully`);
            }
        }
        
        // Update map name when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 DOM loaded, initializing selectors...');
            
            // Set up protection immediately
            protectDropdownFromClearing();
            
            // Initialize selectors with error handling
            try {
                await initializeMapAndDifficultySelectors();
                updateMapName();
                initializeSidebarTabs();
                
                // Wait for marker system to be ready
                console.log('⏳ Waiting for marker system to be ready...');
                await waitForMarkerSystem();
                
                // Verify dropdown is still populated after all initialization
                const difficultySelector = document.getElementById('difficulty-selector');
                console.log('🔍 Final check - Difficulty dropdown has', difficultySelector?.options.length || 0, 'options');
                
                if (difficultySelector && difficultySelector.options.length > 0) {
                    console.log('✅ Difficulty selector populated, setting initial difficulty');
                    const savedDifficulty = sessionStorage.getItem('selectedDifficulty');
                    if (savedDifficulty && difficultySelector.querySelector(`option[value="${savedDifficulty}"]`)) {
                        difficultySelector.value = savedDifficulty;
                        console.log('Set difficulty selector to saved:', savedDifficulty);
                        // Don't apply difficulty settings during initialization - let the marker system handle it naturally
                    } else if (difficultySelector.options.length > 0) {
                        difficultySelector.value = difficultySelector.options[0].value;
                        console.log('Set difficulty selector to default:', difficultySelector.options[0].value);
                        // Don't apply difficulty settings during initialization
                    }
                } else {
                    console.warn('⚠️ Difficulty dropdown is empty after initialization!');
                    // Try to reinitialize
                    const currentMap = sessionStorage.getItem('selectedMap') || 'arena-breakout';
                    console.log('🔄 Attempting to reload difficulties for:', currentMap);
                    await loadDifficultiesForMap(currentMap);
                }
                
                console.log('✅ Initialization complete');
                
            } catch (error) {
                console.error('❌ Error during initialization:', error);
            }
        });
        
        // Make functions globally accessible
        window.toggleSidebar = toggleSidebar;
        window.openSidebar = openSidebar;
        window.closeSidebar = closeSidebar;
        window.resetMapView = resetMapView;
        window.updateMapName = updateMapName;
        
        // Modern Sidebar Tab Functionality
        function initializeSidebarTabs() {
            const tabLinks = document.querySelectorAll('.leaflet-sidebar-tabs a[role="tab"]');
            const tabPanes = document.querySelectorAll('.leaflet-sidebar-pane');
            const sidebar = document.getElementById('sidebar');
            
            // Function to show a specific tab
            function showTab(targetId) {
                // Check if the clicked tab is already active
                const clickedTab = document.querySelector(`a[href="#${targetId}"]`);
                const isAlreadyActive = clickedTab && clickedTab.parentElement.classList.contains('active');
                
                // If tab is already active and sidebar is open, close the sidebar
                if (isAlreadyActive && sidebar && !sidebar.classList.contains('collapsed')) {
                    closeSidebar();
                    return;
                }
                
                // Hide all panes
                tabPanes.forEach(pane => {
                    pane.classList.remove('active');
                });
                
                // Remove active class from all tabs
                tabLinks.forEach(link => {
                    link.parentElement.classList.remove('active');
                });
                
                // Show target pane
                const targetPane = document.getElementById(targetId);
                if (targetPane) {
                    targetPane.classList.add('active');
                }
                
                // Add active class to clicked tab
                const activeTab = document.querySelector(`a[href="#${targetId}"]`);
                if (activeTab) {
                    activeTab.parentElement.classList.add('active');
                }
                
                // Open sidebar when tab is clicked
                if (sidebar && sidebar.classList.contains('collapsed')) {
                    openSidebar();
                }
            }
            
            // Add click event listeners to tabs
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const targetId = href.substring(1); // Remove the # symbol
                    showTab(targetId);
                });
            });
            
            // Add click event listeners to close buttons
            document.querySelectorAll('.leaflet-sidebar-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    closeSidebar();
                });
            });
            
            // Set up first tab as active by default
            if (tabLinks.length > 0) {
                const firstTabHref = tabLinks[0].getAttribute('href');
                const firstTabId = firstTabHref.substring(1);
                
                // Set up first tab as active
                tabPanes.forEach(pane => pane.classList.remove('active'));
                tabLinks.forEach(link => link.parentElement.classList.remove('active'));
                
                const targetPane = document.getElementById(firstTabId);
                if (targetPane) {
                    targetPane.classList.add('active');
                }
                
                const activeTab = document.querySelector(`a[href="#${firstTabId}"]`);
                if (activeTab) {
                    activeTab.parentElement.classList.add('active');
                }
            }
            
            // Always start with sidebar collapsed for clean look
            if (sidebar) {
                sidebar.classList.add('collapsed');
            }
        }
        // Global function access
        window.toggleSidebar = toggleSidebar;
        window.openSidebar = openSidebar;
        window.closeSidebar = closeSidebar;
        window.resetMapView = resetMapView;
        window.updateMapName = updateMapName;
        
        // Handle window resize for responsive behavior
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                // Always keep collapsed on resize for consistency
                sidebar.classList.add('collapsed');
                adjustMapControls();
            }
        });
    </script>
</body>

</html>
